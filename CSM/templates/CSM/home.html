{% extends "CSM/include/base.html" %}

{% load static %}

{% block title %}
    Home Page
{% endblock  %}

{% block css %}

  <style>
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
{% endblock  %}

{% block content %}
    {% include "CSM/include/nav.html" %}
        <div class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
        <section class="flex justify-center flex-1">
            form
            <div class="container my-4 px-4 flex h-auto ">
                <!-- Senders container -->
                <div class="w-[20%] min-h-[26rem] max-h-[27rem] flex flex-col-reverse gap-1 border-r-4 border-solid border-slate-400 bg-cyan-500 rounded-l-lg overflow-hidden overflow-y-auto scroll-smooth sender-container">
                    {% if messages  != 0 %}
                        {% for message in messages %}
                            {% if message.id in unreaded %}
                                <a class="bg-red-200 cursor-pointer rounded-l-lg w-full text-neutral-500 transition duration-200 hover:bg-slate-100 hover:text-blue-700 hover:ease-in-out focus:text-green-200 disabled:text-black/30 dark:text-neutral-200 dark:hover:text-neutral-300 dark:focus:text-neutral-300 sm:flex [&amp;.active]:text-black/90 dark:[&amp;.active]:text-zinc-400 motion-reduce:transition-none user" 
                                    id="{{message.reciever}}{{message.id}}"
                                    data-message-id="{{ message.id }}">
                                    <!-- Image of The Sender -->
                                    <div class="lg:flex lg:flex-col lg:items-center lg:justify-center lg:mx-2 hidden">
                                        <img src="{{message.sender.employee.profile_pic.url}}" class="bg-red-600 border border-solid border-1 border-slate-600 rounded-full w-[50px] h-[50px]">
                                    </div>
                                    <!-- First Name and Last Name of The Sender -->
                                    <div class="flex flex-col justify-center px-2 mx-2">
                                        <span class="text-sm min-w-[6rem]">{{ message.sender.first_name }}</span>
                                        <span class="text-sm min-w-[6rem]">{{ message.sender.last_name }}</span>
                                    </div>
                                </a>
                            {% else %}
                                <a class="bg-yellow-100 cursor-pointer rounded-l-lg w-full text-neutral-500 transition duration-200 hover:bg-slate-100 hover:text-blue-700 hover:ease-in-out focus:text-green-700 disabled:text-black/30 dark:text-neutral-200 dark:hover:text-neutral-300 dark:focus:text-neutral-300 sm:flex [&amp;.active]:text-black/90 dark:[&amp;.active]:text-zinc-400 motion-reduce:transition-none user" 
                                    id="{{message.reciever}}{{message.id}}"
                                    data-message-id="{{ message.id }}">
                                    <!-- Image of The Sender -->
                                    <div class="lg:flex lg:flex-col lg:items-center lg:justify-center lg:mx-2 hidden">
                                        <img src="{{message.sender.employee.profile_pic.url}}" class="bg-red-600 border border-solid border-1 border-slate-600 rounded-full w-[50px] h-[50px]">
                                    </div>
                                    <!-- First Name and Last Name of The Sender -->
                                    <div class="flex flex-col justify-center px-2 mx-2">
                                        <span class="text-sm min-w-[6rem] drop-shadow">{{ message.sender.first_name }}</span>
                                        <span class="text-sm min-w-[6rem] drop-shadow">{{ message.sender.last_name }}</span>
                                    </div>
                                </a>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <!-- Message Container -->
                <div class="w-[80%] min-h-[26rem] max-h-[27rem] flex flex-col">
                    <!-- Title of The Message -->
                    <div class="flex justify-center w-full h-[10%] border-b-2 border-solid border-slate-400 px-2 mx-2 bg-cyan-500 drop-shadow-2xl">
                        {% comment %} {% for message in messages %} {% endcomment %}
                            <span class="message-title px-2 mx-2 my-2 text-xl text-yellow-300"></span>
                        {% comment %} {% endfor %} {% endcomment %}
                    </div>
                    <!-- The Message -->
                    <div class="w-full px-2 py-2 mx-2 h-[80%] grid content-between">
                        {% comment %} {% for message in messages %} {% endcomment %}
                            <p class="message-content text-2xl overflow-y-auto whitespace-pre-line"></p>
                            <div class="files flex border-2 border-slate-300 bg-cyan-100 max-w-[75%] min-w-[15rem] min-h-[3rem]">
                            </div>
                        {% comment %} {% endfor %}  {% endcomment %}
                    </div>
                    <!-- Information About the Message -->
                    <div class="w-full h-[10%] flex items-center justify-center px-2 mx-2 border-t-2 border-slate-400 bg-cyan-500 drop-shadow-2xl">
                        <span class="message-date text-yellow-300"></span>
                    </div>
                </div>

            </div>
        </section>
    {% include "CSM/include/footer.html" %}
{% endblock  %}

{% block scripts %}

    <script>
        $(document).ready(function () {
            
            var loading = $(".loading-overlay");
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            $(document).on('click', '.user',function (e){ 
                e.preventDefault();
                var messageId = $(this).data('message-id');
                var csrfToken = getCookie('csrftoken');
                loading.css("display", "flex");
                $.ajax({
                    type: 'POST',
                    url: '{% url "CSM:markItRead" %}',
                    data: {'message_id': messageId},
                    success: function (data) {
                        // Make the Date in Readable Format -start-
                        var formattedDate = new Date(data.date);
                        var options = { day: 'numeric', month: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'};
                        var formattedDateString = formattedDate.toLocaleDateString('fr-FR', options);
                        // -end-
                        // a function to check whether the message in arabic or Not -Start-
                        function containsArabicCharacters(str) {
                        var arabicRegex = /[\u0600-\u06FF]/;
                        return arabicRegex.test(str);
                        }
                        if (containsArabicCharacters(data.content)) {
                            $('.message-content').html(data.content);
                            $('.message-content').attr('dir', 'rtl');
                        } else {
                            $('.message-content').html(data.content);
                            $('.message-content').attr('dir', 'ltr');
                        }
                        // -end-
                        $('.message-title').html(data.title);
                        $('.message-date').html(formattedDateString);
                        var filesContainer = $('.files');
                        filesContainer.empty(); // Clear previous content

                        if (data.fichiers && data.fichiers.length > 0) {
                            var filesList = $('<ul class="flex gap-5 overflow-x-scroll"></ul>');

                            data.fichiers.forEach(function(urlfile) {
                                var listItem = $('<li class=\"bg-red-100 flex items-center px-2 mx-2 gap-1\"><i class=\"fa-regular fa-file\"></i></li>');
                                var fileLink = $('<a></a>', {
                                    class : "cursor-pointer text-xl",
                                    href: urlfile,
                                    target: '_blank',
                                    text: urlfile.split('/').pop() // Display the file name
                                });
                                listItem.append(fileLink);
                                filesList.append(listItem);
                            });

                            filesContainer.append(filesList);
                        } else {
                            filesContainer.html('No attached files');
                        }

                    },
                    error: function (xhr, status, error) {
                        $('.message-content').html('Error submitting the form');
                        $('.message-title').html('Error submitting the form');
                        $('.message-date').html('Error submitting the form');
                    },
                    complete: function () {
                        // Hide loading overlay after the request is completed (success or error)
                        loading.css("display", "none");
                    }
                });
                $(this).removeClass("bg-red-200");
                $(this).addClass("bg-green-100");
            });
            var lastCheckTime = new Date().toISOString();
            
            function fetchNewMessages(){
                var employeeId = {{ request.user.id }}
                $.ajax({
                    type    :"GET",
                    url     : "{% url 'CSM:newMessages' %}",
                    data    : {'employeeId' : employeeId,
                               'date_message' :  lastCheckTime },
                    success : function (data){
                        $('.sender-container').append(data.latestMessage);
                        lastCheckTime =  new Date().toISOString();
                    },
                    error   : function (xhr, status, error){
                        console.error('Error:', error);
                    }
                });
            }
            setInterval(fetchNewMessages, 8000);

        });
    </script>
    
{% endblock %}



